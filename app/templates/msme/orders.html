{% extends "base.html" %}

{% block title %}My Orders{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/order.css') }}">
{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h2>My Orders</h2>
        <a href="{{ url_for('msme.add_order') }}" class="btn btn-primary">Add New Order</a>
    </div>

    <!-- Warehouse Filter -->
    <div class="warehouse-filter-section">
        <h3>Filter by Warehouse</h3>
        <div class="filter-options">
            <a href="{{ url_for('msme.orders') }}" class="filter-option {{ 'active' if not selected_warehouse }}">
                All Warehouses
            </a>
            {% for warehouse in current_user.warehouses %}
            <a href="{{ url_for('msme.orders', warehouse_id=warehouse.id) }}" 
               class="filter-option {{ 'active' if selected_warehouse and selected_warehouse.id == warehouse.id }}">
                {{ warehouse.name }}
            </a>
            {% endfor %}
        </div>
    </div>

    <!-- Order Type Filter -->
    <div class="order-type-filter-section">
        <h3>Filter by Order Type</h3>
        <div class="filter-options">
            <a href="{{ url_for('msme.orders', warehouse_id=selected_warehouse.id if selected_warehouse else None) }}" 
               class="filter-option {{ 'active' if not selected_order_type }}">
                All Orders
            </a>
            <a href="{{ url_for('msme.orders', warehouse_id=selected_warehouse.id if selected_warehouse else None, order_type='incoming') }}" 
               class="filter-option {{ 'active' if selected_order_type == 'incoming' }}">
                üîÑ Incoming Orders
            </a>
            <a href="{{ url_for('msme.orders', warehouse_id=selected_warehouse.id if selected_warehouse else None, order_type='outgoing') }}" 
               class="filter-option {{ 'active' if selected_order_type == 'outgoing' }}">
                üì§ Outgoing Orders
            </a>
        </div>
    </div>

    <!-- Additional Filters -->
    <div class="filter-section">
        <div class="filter-row">
            <div class="filter-group">
                <label class="filter-label">Priority</label>
                <select class="filter-select" onchange="filterOrders('priority', this.value)">
                    <option value="">All Priority</option>
                    <option value="high">High</option>
                    <option value="medium">Medium</option>
                    <option value="low">Low</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label">Date Range</label>
                <input type="date" class="filter-input" onchange="filterOrders('date', this.value)">
            </div>
            <div class="filter-group">
                <label class="filter-label">Search Orders</label>
                <input type="text" class="filter-input" placeholder="Search by Order ID, Customer..." onkeyup="searchOrders(this.value)">
            </div>
        </div>
    </div>

    {% if selected_warehouse or selected_order_type %}
    <div class="active-filters">
        <h3>Active Filters:</h3>
        <div class="filter-tags">
            {% if selected_warehouse %}
            <span class="filter-tag warehouse">
                Warehouse: {{ selected_warehouse.name }}
                <a href="{{ url_for('msme.orders', order_type=selected_order_type) }}" class="remove-filter">√ó</a>
            </span>
            {% endif %}
            {% if selected_order_type %}
            <span class="filter-tag order-type">
                Order Type: {{ 'Incoming' if selected_order_type == 'incoming' else 'Outgoing' }}
                <a href="{{ url_for('msme.orders', warehouse_id=selected_warehouse.id if selected_warehouse else None) }}" class="remove-filter">√ó</a>
            </span>
            {% endif %}
        </div>
        <a href="{{ url_for('msme.orders') }}" class="btn btn-outline">Clear All Filters</a>
    </div>
    {% endif %}

    <div class="orders-container">
        {% if orders %}
        <!-- Orders Table -->
        <div class="orders-table-container">
            <div class="table-scroll">
                <table class="orders-table">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Customer Details</th>
                            <th>Product Information</th>
                            <th>Order Date</th>
                            <th>Delivery Address</th>
                            <th>Order Type</th>
                            <th>Priority</th>
                            <th>Warehouse</th>
                            <th>Logistics</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="ordersTableBody">
                        {% for order in orders %}
                        <tr onclick="selectOrder(this)" data-order-id="{{ order.id }}">
                            <td class="order-id">Order #{{ order.id }}</td>
                            <td>
                                <div class="customer-info">
                                    <div class="primary-text">
                                        {% if order.customer_name %}
                                            {{ order.customer_name }}
                                        {% else %}
                                            {{ order.supplier_name or 'N/A' }}
                                        {% endif %}
                                    </div>
                                    <div class="secondary-text">
                                        {% if order.customer_phone %}
                                            {{ order.customer_phone }}
                                        {% elif order.supplier_phone %}
                                            {{ order.supplier_phone }}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="product-info">
                                    <div class="primary-text">{{ order.package_name }}</div>
                                    <div class="secondary-text">Type: {{ order.package_type|title }}</div>
                                    <div class="secondary-text">Qty: {{ order.quantity }}</div>
                                </div>
                            </td>
                            <td>
                                <div class="primary-text">{{ order.date.strftime('%d-%m-%Y') }}</div>
                                <div class="secondary-text">{{ order.time_slot }}</div>
                            </td>
                            <td>
                                <div class="delivery-info">
                                    <div class="primary-text">{{ order.delivery_address[:30] }}...</div>
                                    <div class="secondary-text">{{ order.pickup_address[:30] }}...</div>
                                </div>
                            </td>
                            <td>
                                {% if order.date < now_date %}
                                <div class="status-badge status-complete">Delivered</div>
                                {% else %}
                                <div class="order-type-badge {{ order.order_type }}">
                                    {% if order.order_type == 'incoming' %}
                                        üîÑ Incoming
                                    {% else %}
                                        üì§ Outgoing
                                    {% endif %}
                                </div>
                                {% endif %}
                            </td>
                            <td>
                                <div class="priority-badge {{ order.package_priority }}">
                                    {{ order.package_priority|title }}
                                </div>
                            </td>
                            <td>
                                <div class="warehouse-badge">{{ order.warehouse.name }}</div>
                            </td>
                            <td>
                                <div class="logistics-info">
                                    <div class="primary-text">{{ order.logistic_company }}</div>
                                    {% if order.driver %}
                                    <div class="secondary-text">{{ order.driver.name }}</div>
                                    {% else %}
                                    <div class="secondary-text">No driver</div>
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <a href="{{ url_for('msme.order_detail', order_id=order.id) }}" class="btn btn-outline btn-sm">View</a>
                                    <form method="POST" action="{{ url_for('msme.delete_order', order_id=order.id) }}" 
                                          style="display: inline;" 
                                          onsubmit="return confirm('Are you sure you want to delete this order? This action cannot be undone.')">
                                        <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% else %}
        <div class="empty-state">
            {% if selected_warehouse %}
            <h3>No Orders in {{ selected_warehouse.name }}</h3>
            <p>There are no orders associated with this warehouse yet.</p>
            {% else %}
            <h3>No Orders Yet</h3>
            <p>You haven't created any orders yet. Create your first order to get started.</p>
            {% endif %}
            <a href="{{ url_for('msme.add_order') }}" class="btn btn-primary">Create Your First Order</a>
        </div>
        {% endif %}
    </div>
    
    <div class="back-link">
        <a href="{{ url_for('msme.dashboard') }}">‚Üê Back to Dashboard</a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/order.js') }}"></script>
{% endblock %}
